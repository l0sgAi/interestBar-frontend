name: Deploy to Vercel

on:
  # å½“æ¨é€åˆ° vercel-deploy åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: ['vercel-deploy']

  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: æ„å»ºé¡¹ç›®
        env:
          # ç”Ÿäº§ç¯å¢ƒ API åœ°å€ï¼ˆå»ºè®®åœ¨ Vercel Dashboard ä¸­é…ç½®ï¼Œè¿™é‡Œåªæ˜¯å¤‡ç”¨ï¼‰
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
          VITE_OAUTH_CALLBACK_URL: ${{ secrets.VITE_OAUTH_CALLBACK_URL }}
          VITE_BASE_URL: '/'
        run: npm run build

      - name: æ£€æŸ¥æ„å»ºäº§ç‰©
        run: |
          echo "æ„å»ºäº§ç‰©åˆ—è¡¨:"
          ls -la dist/
          echo ""
          echo "æ£€æŸ¥å…³é”®æ–‡ä»¶:"
          test -f dist/index.html && echo "âœ“ index.html å­˜åœ¨"
          test -f dist/assets/index.js && echo "âœ“ index.js å­˜åœ¨"

      # å¯é€‰ï¼šå°†æ„å»ºäº§ç‰©ä¸Šä¼ ä¸º artifactï¼Œæ–¹ä¾¿è°ƒè¯•
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: ./dist
          retention-days: 7

  # è¿™ä¸ª job åªæ˜¯ä¸€ä¸ªé€šçŸ¥ï¼Œå®é™…çš„éƒ¨ç½²ç”± Vercel é€šè¿‡ GitHub App è‡ªåŠ¨å®Œæˆ
  notify:
    needs: build
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
        run: |
          echo "âœ… æ„å»ºæˆåŠŸï¼"
          echo "ğŸ“¦ Vercel ä¼šè‡ªåŠ¨ä» vercel-deploy åˆ†æ”¯éƒ¨ç½²"
          echo "ğŸ”— æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€: https://vercel.com/dashboard"
